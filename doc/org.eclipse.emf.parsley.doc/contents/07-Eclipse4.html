<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<title>Eclipse 4.x</title>

<link href="book.css" rel="stylesheet" type="text/css">
<link href="code.css" rel="stylesheet" type="text/css">
<link rel="home" href="00-Main.html" title="">
</head>
<body>
<a name="Eclipse4"></a>
<h1>Eclipse 4.x</h1>
<p>
Instead of using the Extension Point mechanism, EMF Parsley leverages from DSL and Google Guice Injection.
</p>
<p>
Because of this, it is very easy to use it with Eclipse 4.x (e4).
</p>
<a name="GetFirstExample"></a>
<h2>First Example Setup</h2>
<p>
If you followed the steps described in section <a href="02-FirstExample.html#FirstExample" title="Go to &quot;First Example&quot;">First Example</a> you will have already
what we need to begin. Otherwise the following wizard will bring you to that point.
</p>
<p>
<ol>
	<li>
		File -&gt; New... -&gt; Example...
	</li>
	<li>
		from Category "Emf Parsley Examples", select "Emf Parsley First Example"
	</li>
	<li>
		press Next and Finish
	</li>
</ol>
</p>
<p>
You will end up with three plug-ins:
</p>
<p>
<ul>
	<li>
		org.eclipse.emf.parsley.examples.firstexample (the EMF Parsley example plug-in)
	</li>
	<li>
		org.eclipse.emf.examples.library (the model plug-in)
	</li>
	<li>
		org.eclipse.emf.examples.library.edit (the model.edit plug-in)
	</li>
</ul>
</p>
<p>
As a reminder, in section <a href="02-FirstExample.html#FirstExample" title="Go to &quot;First Example&quot;">First Example</a> we reached the point where we launched a second Eclipse
instance (but, of course, just defining a product you could have a standalone 3.x application) with a
view (called "My Library Tree Form") that allowed to manage the model.
</p>
<a name="PrepareForEclipse4Application"></a>
<h2>Preparing for a pure e4 Application</h2>
<p>
What we will do now is starting from the previous step and create an e4 Application (on top of
the previous plug-ins) that gets to the same result, but now with a pure e4 Part.
</p>
<p>
In order to do this we need to export the <em>"org.eclipse.emf.parsley.examples.firstexample"</em> package from the first plug-in.
</p>
<a name="CreateEclipse4Application"></a>
<h2>Create an e4 Application</h2>
<p>
Now let&apos;s create a new, empty, e4 application, e.g. <em>"org.eclipse.emf.parsley.examples.firstexample.application"</em>
(you can find details on how to create e4 applications in <a href="http://www.rcp-vision.com/?p=4694&lang=en">our
tutorials</a>).
</p>
<p>
Create a Part and ensure that the application starts.
</p>
<a name="Eclipse4ApplicationAndEMFParsley"></a>
<h2>Using a TreeComposite into an e4 Part</h2>
<p>
In the just created plug-in we need dependencies from the previous plug-ins: so open the <em>org.eclipse.emf.parsley.examples.firstexample.application/MANIFEST.MF</em> file, go to <em>Dependencies</em>
tab and add the three previous plug-ins. Add also <em>"org.eclipse.emf.parsley"</em> plug-in.
Don&apos;t forget to add the previous, and the required plug-ins, also to the Product.
</p>
<p>
Open the Part java class and make the following changes:
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
<span class="comment">//&nbsp;Use&nbsp;these&nbsp;imports&nbsp;during&nbsp;Organizing&nbsp;Imports&nbsp;operation<br/>
</span><span class="keyword">import</span>&nbsp;org.eclipse.emf.common.util.URI;<br/>
<span class="keyword">import</span>&nbsp;org.eclipse.emf.ecore.resource.Resource;<br/>
<span class="keyword">import</span>&nbsp;org.eclipse.swt.widgets.Composite;<br/>
<br/>
<span class="comment">//&nbsp;The&nbsp;part&nbsp;implements&nbsp;IMenuListener&nbsp;for&nbsp;context&nbsp;menu&nbsp;handling<br/>
</span><span class="keyword">public</span>&nbsp;<span class="keyword">class</span>&nbsp;MyEclipse4Part&nbsp;{<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//the&nbsp;EMF&nbsp;Parley&nbsp;composite&nbsp;for&nbsp;showing&nbsp;a&nbsp;tree&nbsp;and&nbsp;a&nbsp;detail&nbsp;form<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span>&nbsp;TreeFormComposite&nbsp;treeFormComposite;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//the&nbsp;EMF&nbsp;Resource<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span>&nbsp;Resource&nbsp;resource;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//URI&nbsp;for&nbsp;EMF&nbsp;Resource<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span>&nbsp;URI&nbsp;uri&nbsp;=&nbsp;URI.createFileURI(System.getProperty(<span class="string">"user.home"</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;<span class="string">"/MyLibrary.library"</span>);<br/>
<br/>
</p>
</div>
</div>
</p>
<p>
Modify the <em>@PostConstruct</em> method with this code:
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
@PostConstruct<br/>
<span class="keyword">public</span>&nbsp;<span class="keyword">void</span>&nbsp;postConstruct(Composite&nbsp;parent)&nbsp;<span class="keyword">throws</span>&nbsp;Exception&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Guice&nbsp;injector<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">private</span>&nbsp;Injector&nbsp;injector&nbsp;=&nbsp;FirstexampleInjectorProvider.getInjector();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;The&nbsp;EditingDomain&nbsp;is&nbsp;needed&nbsp;for&nbsp;context&nbsp;menu&nbsp;and&nbsp;drag&nbsp;and&nbsp;drop<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;EditingDomain&nbsp;editingDomain&nbsp;=&nbsp;injector.getInstance(EditingDomain.<span class="keyword">class</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;ResourceLoader&nbsp;resourceLoader&nbsp;=&nbsp;injector.getInstance(ResourceLoader.<span class="keyword">class</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//load&nbsp;the&nbsp;resource<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;resource&nbsp;=&nbsp;resourceLoader.getResource(editingDomain,&nbsp;uri).getResource();<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;TreeFormFactory&nbsp;treeFormFactory&nbsp;=&nbsp;injector.getInstance(TreeFormFactory.<span class="keyword">class</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//create&nbsp;the&nbsp;tree-form&nbsp;composite<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;treeFormComposite&nbsp;=&nbsp;treeFormFactory.createTreeFormComposite(parent,&nbsp;SWT.BORDER);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Guice&nbsp;injected&nbsp;viewer&nbsp;context&nbsp;menu&nbsp;helper<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;ViewerContextMenuHelper&nbsp;contextMenuHelper&nbsp;=&nbsp;injector.getInstance(ViewerContextMenuHelper.<span class="keyword">class</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Guice&nbsp;injected&nbsp;viewer&nbsp;drag&nbsp;and&nbsp;drop&nbsp;helper<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;ViewerDragAndDropHelper&nbsp;dragAndDropHelper&nbsp;=&nbsp;injector.getInstance(ViewerDragAndDropHelper.<span class="keyword">class</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;set&nbsp;context&nbsp;menu&nbsp;and&nbsp;drag&nbsp;and&nbsp;drop<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;contextMenuHelper.addViewerContextMenu(treeFormComposite.getViewer(),&nbsp;editingDomain);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;dragAndDropHelper.addDragAndDrop(treeFormComposite.getViewer(),&nbsp;editingDomain);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//update&nbsp;the&nbsp;composite<br/>
</span>&nbsp;&nbsp;&nbsp;&nbsp;treeFormComposite.update(resource);<br/>
}<br/>
</p>
</div>
</div>
</p>
<p>
If you now run the application you will be able to manage the model:
</p>
<p>
<div class="image" >
<img src="images/07-eclipse4-part.png" class=" " 
/>
<div class="caption">
</div>
</div>
</p>
<p>
but you will notice that it is not possible to persist the changes to the model.
</p>
<a name="Eclipse4Save"></a>
<h2>Adding the dirty state and Save command</h2>
<p>
In order to allow persisting the model changes we have to add the dirty state handling to the part and
the Save command to the application.
Let&apos;s start with adding the following attribute to the part
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
@Inject<br/>
MDirtyable&nbsp;dirty;<br/>
</p>
</div>
</div>
</p>
<p>
add to <em>@PostConstruct</em> method the following code in order to update the dirty state
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
editingDomain.getCommandStack().addCommandStackListener(<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">new</span>&nbsp;CommandStackListener()&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span>&nbsp;<span class="keyword">void</span>&nbsp;commandStackChanged(EventObject&nbsp;event)&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(dirty&nbsp;!=&nbsp;null)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirty.setDirty(<span class="keyword">true</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br/>
</p>
</div>
</div>
</p>
<p>
and add the <em>@Persist</em> method, which will be called when the part is saved
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
@Persist<br/>
<span class="keyword">public</span>&nbsp;<span class="keyword">void</span>&nbsp;save(MDirtyable&nbsp;dirty)&nbsp;<span class="keyword">throws</span>&nbsp;IOException&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;resource.save(null);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(dirty&nbsp;!=&nbsp;null)&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dirty.setDirty(<span class="keyword">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
}<br/>
</p>
</div>
</div>
</p>
<p>
and, in the end, add the <em>Save</em> handler along with the correspondent <em>Command</em> and <em>Menu</em>
(you can find how to create handlers, commands and menus in an e4 applications in <a href="http://www.rcp-vision.com/?p=4972&lang=en">our
tutorials</a>)
</p>
<p>
<div class="literallayout">
<div class="incode">
<p class="code">
<span class="keyword">import</span>&nbsp;javax.inject.Named;<br/>
<br/>
<span class="keyword">public</span>&nbsp;<span class="keyword">class</span>&nbsp;SaveHandler&nbsp;{<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;@Execute<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">void</span>&nbsp;execute(EPartService&nbsp;partService,&nbsp;@Named(IServiceConstants.ACTIVE_PART)&nbsp;MPart&nbsp;part)&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;partService.savePart(part,&nbsp;<span class="keyword">false</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
}<br/>
</p>
</div>
</div>

</p>
</body>
</html>
